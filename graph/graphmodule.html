<!DOCTYPE html>
<html>
	<head>
    <meta http-equiv="content-type" content = "text/html; charset= UTF-8"/>
	<script src="plotly.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script src="xml2json.js"></script>
	</head>
	<body>
	<div class="navbar" id="toptitle"><span>Real-Time Telemetry Data: </span></div>
	<div class="wrapper">
		<div id="chart"></div>
		<div id="chart0"></div>
		<div id = "bottomchart2">
	<table style="width:100%" id = "traces2">
			<tr id = "fieldnames2">
			</tr>
			<tr id = "data2">
			</tr> 
		</table>
		</div>
		<script src="xml2json.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script>	
		/**
		Graphs backend API data using endpoints.
		Input: valid endpoint URL, valid Authentication Token.
		Output: Plotly graph.
		**/
			console.log('start');
			var done = false;
			var keys = [];
			var numKeys = 0;
			var rawvalues = [];
			var keysValues = [];
			var json = "";	
			const myHeaders = new Headers();
			var url = 'http://127.0.0.1:8000/api/';
			
			/**
			For Changing Token in Headers for CORS and Authentication.
			**/
			function testheaders(myHeaders){
			myHeaders.append('Content-Type', 'application/json');
			myHeaders.append('Authorization', 'Token cc3c47b2ca27352dd789a67ff5ad847d189adc84');
			window.myHeaders = myHeaders;
			}
			
			/**
			For changing URL endpoints in backend API.
			Contains all valid possible endpoints. 
			**/
			function testurl(url){
			//url = url+'sat/';
			//url = url+'comp/';
			//url = url+'meas/';
			//url = url+'units/';
			//url = url+'sat/6/comp/';
			//url = url+'sat/6/recent/10';
			url = url+'sat/6/comp/14/recent/10/';
			//url = url+'sat/6/comp/1+2+3/recent/10';
			//url = url+'sat/6/meas/from=2019-01-01T22:43:23/to=now';
			//url = url+'sat/6/meas/comp/10/from=2019-01-01T22:43:23/to=2019-11-19T00:00:00/';
			//url = url+'sat/6/meas/comp/1+2+3/from=2019-01-01T22:43:23/to=2019-11-19T00:00:00'/;
			window.url = url;
			}
			
			testheaders(myHeaders);
			testurl(url);
			var request = new Request(url,{method: 'GET', headers: myHeaders, });
			fetch(request)//, {mode: 'no-cors', headers: {'Access-Control-Allow-Origin':'*'}})//"same-origin"})//no-cors"})
				.then(res => res.json())
				.then((out) => {
					var testType = 3;
					if(testType==3){
						console.log('test full API', out);
						if(out.data==true){
							var mydiv = document.getElementById("toptitle");
							var newcontent = document.createElement('div');
							newcontent.innerHTML = out.Satellite.name+": Launched "+out.Satellite.year_launched;
							while (newcontent.firstChild) {
								mydiv.appendChild(newcontent.firstChild);
							}
							var compSpecified = false;
							compSpecified = out.comp_specified;
							console.log('Component Specified?: ', compSpecified);
							var outSort = out;
							var measurementsComponent_Category = [];
							var measurementsComponent_Description = [];
							var measurementsComponent_Model = [];
							var measurementsComponent_Name = [];
							var measurementsTime = [];
							var measurementsUnits = [];
							var measurementsValue = [];
							var data = [];
							
							var quantity = out.Quantities.CPU; //Quantity has been replaced; therefore, quantity test should always fail.
							var realQuantity = 0;
							realQuantity = out.Measurements.length;
							var checkQuantities = false;
							if(quantity==realQuantity){
								checkQuantities = true;
							}
							console.log('Quantity: ', quantity);
							console.log('Real Quantity: ', realQuantity);
							console.log('Test: Quantities Match? : ', checkQuantities);
							
							for(var a=0;a<realQuantity;a++){
								if(compSpecified == true){
								measurementsComponent_Category.push(out.Measurements[a].component_category[0]);
								measurementsComponent_Description.push(out.Measurements[a].component_description[0]);
								measurementsComponent_Model.push(out.Measurements[a].component_model[0]);
								measurementsComponent_Name.push(out.Measurements[a].component_name[0]);
								}
								measurementsTime.push(out.Measurements[a].time);
								measurementsUnits.push(out.Measurements[a].units);
								measurementsValue.push(out.Measurements[a].value);
							}
							//ignore
//							console.log('Component_Categories: ', measurementsComponent_Category);
							//ignore
//							console.log('Component_Description: ', measurementsComponent_Description);
							//ignore
//							console.log('Component_Model: ', measurementsComponent_Model);
							
							console.log('Component_Name: ', measurementsComponent_Name);
							console.log('Time: ', measurementsTime);
							console.log('Units: ', measurementsUnits);
							console.log('Value: ', measurementsValue);
							
							for(var c=0;c<realQuantity;c++){
								var dataUnit = [];
								if(compSpecified == true){
								dataUnit.push(measurementsComponent_Category[c]);
								dataUnit.push(measurementsComponent_Description[c]);
								dataUnit.push(measurementsComponent_Model[c]);
								dataUnit.push(measurementsComponent_Name[c]);
								}
								dataUnit.push(measurementsTime[c]);
								dataUnit.push(measurementsUnits[c]);
								dataUnit.push(measurementsValue[c]);
								data.push(dataUnit);
							}
							console.log('Test Formatted Data Array: ', data);
							
							function compare(a,b){
								if(a.units<b.units){
									return -1;
								}
								if(a.units>b.units){
									return 1;
								}
								return 0;
							}
							outSort.Measurements.sort(compare);
//						console.log('Test Sorted Out: ', outSort.Measurements);
							var sortedMeasurements = [];
							var allUnits = [];
							var allNames = [];
								for(var a=0;a<realQuantity;a++){
									sortedMeasurements.push(outSort.Measurements[a]);
									allUnits.push(outSort.Measurements[a].units);
									if(compSpecified==true){
									allNames.push(outSort.Measurements[a].component_name[0]);
									}
								}
						console.log('Test SortedMeasurements JSON: ', sortedMeasurements);
							
							const distinct = (value, index, self) => {
								return self.indexOf(value) === index;
							}
							const distinctUnits = allUnits.filter(distinct);
						console.log('Test Distinct Units: ', distinctUnits);
							var numUniqueUnits = distinctUnits.length;
						console.log('Test Num Unique Units: ', numUniqueUnits);
							const distinctNames = allNames.filter(distinct);
						console.log('Test Distinct Names: ', distinctNames);
							var numUniqueNames = distinctNames.length;
						console.log('Test Num Unique Names: ', numUniqueNames);
						//Alternative
//						const alternativeDistinctUnits = [...new Set(sortedMeasurements.map(x => x.units))];
//						console.log('Alternative Test Distinct Units 2: ', alternativeDistinctUnits);
						//Alternative
							var totalNumGraphs = numUniqueUnits*numUniqueNames;
							if(compSpecified == false){
								totalNumGraphs = numUniqueUnits;
							}
						console.log('Total Num Graphs: ', totalNumGraphs);
							
							var totalGraphsArray = [];
							var totalGraphsArrayForm = []
							for(var a=0;a<totalNumGraphs;a++){
								//make dummy positions
								var dummyGraph = [];
								totalGraphsArray.push(dummyGraph);
								totalGraphsArrayForm.push(dummyGraph);
							}
						console.log('Test Empty Total Graphs Array: ', totalGraphsArray);
							
							function compareNames(a,b){
								if(a.component_name[0]<b.component_name[0]){
									return -1;
								}
								if(a.component_name[0]>b.component_name[0]){
									return 1;
								}
								return 0;
							}
							
							if(compSpecified == false){
								numUniqueNames = 1;
							}
							
							for(var a=0;a<realQuantity;a++){
							//for all 7 data values
							//ex. MainCPU2, Degrees Celcius(sic)
								var subsectionSameUnit = [];
								for(var b=0;b<numUniqueUnits;b++){
								//for each unique unit Degrees, GHz, Volts
								//3 times for each point
								//ex. Degrees Celcius
									//if(compSpecified==true){
									for(var c=0;c<numUniqueNames;c++){
										if(sortedMeasurements[a].units==distinctUnits[b]){
											//all data points with the same unique unit
											//matching distinct unit
											//current point 
											//ex. MainCPU2, Degrees Celcius. 
							//			subsectionSameUnit.push(sortedMeasurements[a]);		
											if(sortedMeasurements[a].component_name==distinctNames[c]){
												//all data points with the same unique name
												//matching distinct name 
												totalGraphsArray[b*numUniqueNames+c].push(sortedMeasurements[a]);
										/*		var dataUnit2 = [];
												dataUnit2.push(sortedMeasurements[a].component_category[0]);
												dataUnit2.push(sortedMeasurements[a].component_description[0]);
												dataUnit2.push(sortedMeasurements[a].component_model[0]);
												dataUnit2.push(sortedMeasurements[a].component_name[0]);
												dataUnit2.push(sortedMeasurements[a].time);
												dataUnit2.push(sortedMeasurements[a].units);
												dataUnit2.push(sortedMeasurements[a].value);
												console.log('dataUnit2', dataUnit2);
												totalGraphsArrayForm[b*numUniqueNames+c].push(dataUnit2);
											*/
											}
											else{
											}
										}
										else{	
										}
										//when finished with same unique units.
										//sort by names, then put into total graph array
							//			subsectionSameUnit.sort(compareNames);
									}
									//}
								}
							}
							console.log('Test Total Graphs Array: ', totalGraphsArray);
							
							console.log('Test Total Graphs Array Length', totalGraphsArray.length);
							
							function compareTime(a,b){
								if(a.time<b.time){
									return -1;
								}
								if(a.time>b.time){
									return 1;
								}
								return 0;
							}			
							//Flip components to list them in correct sequential order.
							for(var a=0;a<totalGraphsArray.length;a++){
								if(totalGraphsArray[a].length>1){
									totalGraphsArray[a].reverse();
									if(compSpecified==false){
										totalGraphsArray[a].sort(compareTime);
									}
								}
							}
							console.log('Test Reordered Total Graphs Array: ', totalGraphsArray);
							console.log('Test Reordered Total Graphs Array Form: ', totalGraphsArrayForm);
							
							//Alternative
							
							var altcurrentData = [];
							for(var a=0;a<totalNumGraphs;a++){
								//no empty graphs
								if (totalGraphsArray[a].length!=0&&totalGraphsArray[a].length!=null){
									for(var b=0;b<totalGraphsArray[a].length;b++){
										altcurrentData.push(totalGraphsArray[a][b].value);
									}
								}
							}
							console.log('AltCurrentData:', altcurrentData);
							
							var testIndex;
							if(compSpecified==true){
								testIndex = 3; //example.
								console.log('Example Specific Unit-Name(Specified): GHz-MainCPU1');
							}
							else{
								testIndex = 1;
								console.log('Example Unspecified Unit-Name(Specified): ');
							}
							exampleGraphData = totalGraphsArray[0][testIndex]; //example. 3 
							console.log('Example Graph Data: ', exampleGraphData);
							exampleTime = [];
							exampleValue = [];
							for(var a=0;a<exampleGraphData.length;a++){
								exampleTime.push(exampleGraphData[a].time); //x
								exampleValue.push(exampleGraphData[a].value); //y
							}
				console.log('ExampleTime', exampleTime);
				console.log('ExampleValue', exampleValue);

							var table = document.getElementById("traces");
							var row = table.insertRow(table.rows.length-1); //insert row at bottom
							var initialDataArray = totalGraphsArray[0][testIndex];
						console.log('Test Initial Data Array', initialDataArray);
							//for(var a=0;a<initialDataArray[0].length;a++){
								//tableKeys.push(Object.keys(initialDataArray[0][a]));
								tableKeys = Object.keys(initialDataArray);
							//}
							for(var b=0;b<tableKeys.length;b++){
								var cellAdd = row.insertCell(b);
								//console.log('tableKeysb', tableKeys[b]);
								var toChart = tableKeys[b];
								cellAdd.innerHTML = (toChart);
							}
				
							var tableKeys = [];
							var tableLog = [];
							var paused = false;
							var alreadyStopped = false;
							function getX(count){
								if(exampleTime[count]!=null){
									//console.log('X Plot: ',exampleTime[count]);
									return exampleTime[count];
								}
								else{
									if(alreadyStopped==false){
										console.log('End of Data.');
										paused = true;
										//clearInterval(interval);
										alreadyStopped=true;
									}
								}
							}
							function getY(count){
								if(exampleValue[count]!=null){
									getData(count);
									//console.log('Y Plot: ', exampleValue[count]);
									return exampleValue[count];
								}
								else{
									if(alreadyStopped==false){
										console.log('End of Data.');
										paused = true;
										//clearInterval(interval);
										alreadyStopped = true;
									}
								}
							}
							function getData(cnt) {
						//console.log('New row', cnt);
									var table = document.getElementById("traces");
									var row = table.insertRow(table.rows.length-1); //insert row at bottom	
						//console.log('test initialDataArray', initialDataArray);
									//for(var r=1;r<initialDataArray.length;r++){//24 times down by column
						//console.log('test tableKeys', Object.values(initialDataArray[cnt]));
										tableKeys = Object.values(initialDataArray[cnt]);
										for(var a=0;a<tableKeys.length;a++){
											var cellAdd = row.insertCell(a);
											var toChart = tableKeys[a];
											cellAdd.innerHTML = (toChart);
										}
									//}
								//return exampleValue;//altcurrentData;//Math.random();
							}  
							Plotly.plot('chart',[{y:[getY(0)],x:[getX(0)],type:'line'}]);
							
							var cnt = 0;
							
							document.getElementById("pause").addEventListener("click", pause);
							function pause() {
								console.log('Stop enabled.');
								paused = true;
							}	
						
			var interval = 	setInterval(function(){
								/*if(cnt<exampleGraphData){ //10 rows
									console.log('New row', cnt);
									var table = document.getElementById("traces");
									var row = table.insertRow(table.rows.length-1); //insert row at bottom	
									for(var r=1;r<initialDataArray.length;r++){//24 times down by column
										tableKeys = Object.values(initialDataArray[r]);
										for(var a=0;a<tableKeys.length;a++){
											var cellAdd = row.insertCell(a);
											//console.log('multipleTraces', multipleTraces[a]);
											var toChart = tableKeys[a];
											cellAdd.innerHTML = (toChart);
										}
									}
								}*/
								//[0] at the end of extendTraces because only 1 example trace.
								Plotly.extendTraces('chart',{ y:[[getY(cnt+1)]], x:[[getX(cnt+1)]]}, [0]); 
								
								cnt++;
								if(cnt > 500) {
									Plotly.relayout('chart',{xaxis: {range: [cnt-500,cnt]}, yaxis: {range: [Math.min(exampleValue),Math.max(exampleValue)]}});
								}
								if(paused == true){
									document.getElementById("pause").innerHTML = "Paused";//Date();
									clearInterval(interval);
									console.log('Stopped!');
								}
							},15);
							
							//Alternative
							
							
/*							//Graphing on Plotly for each array
							var fixChartNumber = 'chart';
							var chartNumber = 'chart';
							var chartNumberExtra = 0;
							for(var a=0;a<totalNumGraphs;a++){
								var currentData = [];
								//no empty graphs
								if (totalGraphsArray[a].length!=0&&totalGraphsArray[a].length!=null){
									for(var b=0;b<totalGraphsArray[a].length;b++){
										currentData.push(totalGraphsArray[a][b].value);
									}
								console.log('Test CurrentData: ', currentData);
								
									var newChartNumber = ""+fixChartNumber+(chartNumberExtra).toString();
								console.log('test New Chart Number: ', newChartNumber);
									chartNumber = newChartNumber;
									var newChart = document.createElement("div");
									newChart.setAttribute("id", ""+fixChartNumber+(chartNumberExtra+1).toString());
									document.getElementById(newChartNumber).appendChild(newChart);
									chartNumberExtra++;
									
									function getData() {
										return currentData;
										//return data;
										//return Math.random();
									}  
								console.log('Test ChartNumber: ', chartNumber);
									//initial plot.
									Plotly.plot(chartNumber,[{y:[getData()],type:'line'}]);
									var cnt = 0;
									//extend new datapoints
									setInterval(function(){
										Plotly.extendTraces(chartNumber,{ y:[[getData()]]}, [currentData.length-1]);
										cnt++;
										//slide along with new data
										if(cnt > 500) {
											Plotly.relayout(chartNumber,{xaxis: {range: [cnt-500,cnt]}});
										}
									},15);
								//setTimeout(function() {
								//}, (3*1000));									
									
								}
								else{
								}
							}
							//Graphing Plotly ends.
*/						
							
							console.log('finish');
						}
						else if(out.data==false){
							var mydiv = document.getElementById("toptitle");
							var newcontent = document.createElement('div');
							newcontent.innerHTML = "Error";
							while (newcontent.firstChild) {
								mydiv.appendChild(newcontent.firstChild);
							}
							var node = document.createElement("p");
							var node2 = document.createElement("p");
							var textnode = document.createTextNode(out.error);
							var textnode2 = document.createTextNode(out.error);
							node.appendChild(textnode);
							node2.appendChild(textnode2);
							document.getElementById("toptitle").appendChild(node);
							document.getElementById("tablechart").appendChild(node2);
							
						}
						else{
							var mydiv = document.getElementById("toptitle");
							var newcontent = document.createElement('div');
							newcontent.innerHTML = "Error";
							while (newcontent.firstChild) {
								mydiv.appendChild(newcontent.firstChild);
							}
							var node = document.createElement("p");
							var node2 = document.createElement("p");
							var textnode = document.createTextNode("Error: The API is not in the correct JSON format. Please check again.");
							var textnode2 = document.createTextNode("Error: The API is not in the correct JSON format. Please check again.");
							node.appendChild(textnode);
							node2.appendChild(textnode2);
							document.getElementById("toptitle").appendChild(node);
							document.getElementById("tablechart").appendChild(node2);
						}
					}
		})
				.catch(err => console.error(err));	
		//}
		</script>
	</div>
	<div id = "bottomchart">
	<p id="tablechart">Table Chart</p>
	<button id="pause">Stop Graph</button>
	<table style="width:100%" id = "traces">
			<tr id = "fieldnames">
			</tr>
			<tr id = "data">
			</tr>
		</table>
	</div>
	</body>
</html>